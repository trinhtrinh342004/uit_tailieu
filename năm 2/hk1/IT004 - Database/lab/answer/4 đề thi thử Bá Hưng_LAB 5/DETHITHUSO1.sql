CREATE DATABASE DETHITHUSO1
GO
USE DETHITHUSO1
GO

CREATE TABLE TACGIA(
    MaTG CHAR(5) PRIMARY KEY,
    HoTen VARCHAR(30),
    DiaChi VARCHAR(50),
    NgSinh SMALLDATETIME,
    SoDT VARCHAR(15)
)

CREATE TABLE SACH(
    MaSach CHAR(5) PRIMARY KEY,
    TenSach VARCHAR(25),
    TheLoai VARCHAR(25)
)

CREATE TABLE TACGIA_SACH(
    MaTG CHAR(5),
    MaSach CHAR(5),
)

CREATE TABLE PHATHANH(
    MaPH CHAR(5) PRIMARY KEY,
    MaSach CHAR(5),
    NgayPH SMALLDATETIME,
    SoLuong INT,
    NhaXuatBan VARCHAR(20),
)

ALTER TABLE TACGIA_SACH
ADD CONSTRAINT FK_TACGIA_SACH_TACGIA FOREIGN KEY (MaTG) REFERENCES TACGIA(MaTG)
GO
ALTER TABLE TACGIA_SACH
ADD CONSTRAINT FK_TACGIA_SACH_SACH FOREIGN KEY (MaSach) REFERENCES SACH(MaSach)
GO
ALTER TABLE PHATHANH
ADD CONSTRAINT FK_PHATHANH_SACH FOREIGN KEY (MaSach) REFERENCES SACH(MaSach)
GO
-- CONSTRAINTS
--TRIGGER: Ngày phát hành (NgayPH) sách phải lớn hơn ngày sinh (NgSinh) của tác giả.
CREATE TRIGGER TR_PHATHANH_NGAYSINH
ON PHATHANH
FOR INSERT, UPDATE
AS
BEGIN
    DECLARE @NGAYSINH SMALLDATETIME, @NGAYPH SMALLDATETIME, @MASACH CHAR(5), @MATG CHAR(5)
    SELECT @NGAYPH = NgayPH, @MASACH = MaSach FROM INSERTED
    SELECT @NGAYSINH = TACGIA.NgSinh, @MATG = TACGIA_SACH.MaTG 
    FROM TACGIA, TACGIA_SACH
    WHERE TACGIA_SACH.MaTG = TACGIA.MaTG AND TACGIA_SACH.MaSach = @MASACH
    IF @NGAYPH < @NGAYSINH
    BEGIN
        RAISERROR('Ngày phát hành (NgayPH) sách phải lớn hơn ngày sinh (NgSinh) của tác giả.', 16, 1)
        ROLLBACK TRANSACTION
    END
END
GO
DROP TRIGGER TR_PHATHANH_NGAYSINH
GO
-- TRIGGER: Sách thuộc thể loại (TheLoai) “Giáo khoa” chỉ do nhà xuất bản (NhaXuatBan) “Giáo dục” phát hành.
CREATE TRIGGER TR_SACH_THELOAI_GIAOKHOA
ON SACH
FOR INSERT, UPDATE
AS
BEGIN
    DECLARE @THELOAI VARCHAR(25), @NXB VARCHAR(20), @MASACH CHAR(5)
    SELECT @THELOAI = TheLoai, @MASACH = MaSach FROM INSERTED
    SELECT @NXB = NhaXuatBan FROM PHATHANH WHERE MaSach = @MASACH
    IF @THELOAI = 'Giáo khoa' AND @NXB <> 'Giáo dục'
    BEGIN
        RAISERROR('Sách thuộc thể loại (TheLoai) “Giáo khoa” chỉ do nhà xuất bản (NhaXuatBan) “Giáo dục” phát hành.', 16, 1)
        ROLLBACK TRANSACTION
    END
END

DROP TRIGGER TR_SACH_THELOAI_GIAOKHOA
--TRUY VẤN
--Tìm tác giả (MaTG,HoTen,SoDT) của những quyển sách thuộc thể loại “Văn học” do nhà xuất bản Trẻ phát hành
SELECT TACGIA.MaTG, TACGIA.HoTen, TACGIA.SoDT
FROM TACGIA, SACH, PHATHANH, TACGIA_SACH
WHERE TACGIA.MaTG = TACGIA_SACH.MaTG AND TACGIA_SACH.MaSach = SACH.MaSach 
    AND SACH.TheLoai = 'Văn học' AND SACH.MaSach = PHATHANH.MaSach 
    AND PHATHANH.NhaXuatBan = 'Trẻ'

--Tìm nhà xuất bản phát hành nhiều thể loại sách nhất.
SELECT TOP 1 WITH TIES NhaXuatBan
FROM PHATHANH, SACH
WHERE PHATHANH.MaSach = SACH.MaSach
GROUP BY NhaXuatBan
ORDER BY COUNT(DISTINCT TheLoai) DESC

--Trong mỗi nhà xuất bản, tìm tác giả (MaTG,HoTen) có số lần phát hành nhiều sách nhất.
SELECT PH.NhaXuatBan, TG.MaTG, TG.HoTen, COUNT(PH.MaSach) AS SoSach
FROM TACGIA TG, TACGIA_SACH TGS, PHATHANH PH, SACH S
WHERE TG.MaTG = TGS.MaTG AND TGS.MaSach = PH.MaSach AND PH.MaSach = S.MaSach
GROUP BY PH.NhaXuatBan, TG.MaTG, TG.HoTen
HAVING COUNT (PH.MaSach) >= ALL (
    SELECT COUNT(PH.MaSach)
    FROM TACGIA TG, TACGIA_SACH TGS, PHATHANH PH, SACH S
    WHERE TG.MaTG = TGS.MaTG AND TGS.MaSach = PH.MaSach AND PH.MaSach = S.MaSach
    GROUP BY TG.MaTG
)


INSERT INTO TACGIA VALUES ('TG01', 'Nguyễn Văn A', 'Hà Nội', '1990-01-01', '0123456789')
INSERT INTO TACGIA VALUES ('TG02', 'Nguyễn Văn B', 'Hà Nội', '1990-01-01', '0123456789')
INSERT INTO TACGIA VALUES ('TG03', 'Nguyễn Văn C', 'Hà Nội', '1990-01-01', '0123456789')

INSERT INTO SACH VALUES ('S01', 'Sách 1', 'Văn học')
INSERT INTO SACH VALUES ('S02', 'Sách 2', 'Văn học')
INSERT INTO SACH VALUES ('S03', 'Sách 3', 'Văn học')
INSERT INTO SACH VALUES ('S04', 'Sách 4', 'Giáo dục')

UPDATE SACH
SET TheLoai = 'Giáo khoa'
WHERE MaSach = 'S04'

INSERT INTO PHATHANH VALUES ('PH01', 'S01', '2020-01-01', 100, 'Trẻ')
INSERT INTO PHATHANH VALUES ('PH02', 'S02', '2020-01-01', 100, 'NXB 1')
INSERT INTO PHATHANH VALUES ('PH03', 'S03', '2020-01-01', 100, 'NXB 1')
INSERT INTO PHATHANH VALUES ('PH04', 'S01', '2020-01-01', 100, 'Trẻ')
INSERT INTO PHATHANH VALUES ('PH05', 'S04', '2020-01-01', 100, 'Trẻ')

DELETE FROM PHATHANH WHERE MaPH = 'PH05'

INSERT INTO TACGIA_SACH VALUES ('TG01', 'S01')
INSERT INTO TACGIA_SACH VALUES ('TG02', 'S02')
INSERT INTO TACGIA_SACH VALUES ('TG03', 'S03')
INSERT INTO TACGIA_SACH VALUES ('TG01', 'S02')
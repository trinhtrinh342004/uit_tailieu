--ĐÈ THI KÊT THÚC HỌC PHẦN 21-22
--Câu 1:
CREATE DATABASE DB2122
USE DB2122

CREATE TABLE NHANVIEN
(
	MANV VARCHAR(3) CONSTRAINT PK_NV PRIMARY KEY,
	HOTEN VARCHAR(40),
	NGSINH SMALLDATETIME,
	PHAI VARCHAR(3),
	DIACHI VARCHAR(50),
	MAPHG VARCHAR(2),
	LUONG MONEY,
)

CREATE TABLE PHONGBAN
(
	MAPHG VARCHAR(2) CONSTRAINT PK_PB PRIMARY KEY,
	TENPHG VARCHAR(50),
	TRPHG VARCHAR(3),
	NGNC SMALLDATETIME,
	CONSTRAINT FK_PB_NV FOREIGN KEY (TRPHG) REFERENCES NHANVIEN(MANV),
)

CREATE TABLE DEAN 
(
	MADA VARCHAR(5) CONSTRAINT PK_DA PRIMARY KEY,
	TENDA VARCHAR(50),
	DDIEM_DA VARCHAR(50),
	MAPHG VARCHAR(2),
	NGBD_DK SMALLDATETIME,
	NGKT_DK SMALLDATETIME,
	CONSTRAINT FK_DA_PB FOREIGN KEY (MAPHG) REFERENCES PHONGBAN (MAPHG),
)

CREATE TABLE PHANCONG
(
	MANV VARCHAR (3),
	MADA VARCHAR(5),
	THOIGIAN INT,
	CONSTRAINT PK_PC PRIMARY KEY (MANV, MADA),
	CONSTRAINT FK_PC_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN (MANV),
	CONSTRAINT FK_PC_DA FOREIGN KEY (MADA) REFERENCES DEAN (MADA),
)

-- ADD KHOA NGOAI CHO QUAN HE NHAN VIEN
ALTER TABLE NHANVIEN 
	ADD CONSTRAINT FK_NV_PB FOREIGN KEY (MAPHG) REFERENCES PHONGBAN (MAPHG)


-------------------------------------------------------------
-------------------------------------------------------------
--Nhập dữ liệu
SET DATEFORMAT DMY

INSERT INTO PHONGBAN VALUES ('QL', 'Quan Ly', NULL, NULL)
INSERT INTO PHONGBAN VALUES ('DH', 'Dieu Hanh', NULL, NULL)
INSERT INTO PHONGBAN VALUES ('NC', 'Nghien Cuu', NULL, NULL)

INSERT INTO NHANVIEN VALUES ('001', 'Vuong Ngoc Quyen', '22/10/1977', 'Nu', '450 Trung Vuong, HaNoi', 'QL', 30000000)
INSERT INTO NHANVIEN VALUES ('002', 'Nguyen Thanh Tu', '09/01/1975', 'Nam', '731 Tran Hung Dao, Q1, TpHCM', 'NC', 25000000)
INSERT INTO NHANVIEN VALUES ('003', 'Le Thi Nhan', '18/12/1980', 'Nu', '291 Ho Van Hue, QPN, TpHCM', 'DH', 25000000)
INSERT INTO NHANVIEN VALUES ('004', 'Dinh Ba Tien', '09/01/1988', 'Nam', '638 Nguyen Van Cu, Q5, TpHCM', 'NC', 32000000)
INSERT INTO NHANVIEN VALUES ('005', 'Bui Thuy Vu', '19/07/1992', 'Nam', '332 Nguyen Thai Hoc, Q1, TpHCM', 'DH', 23000000)

UPDATE PHONGBAN
SET TRPHG = '001', NGNC = '22/05/2018'
WHERE MAPHG = 'QL'

UPDATE PHONGBAN
SET TRPHG = '003', NGNC = '10/10/2020'
WHERE MAPHG = 'DH'

UPDATE PHONGBAN
SET TRPHG = '002', NGNC = '15/03/2020'
WHERE MAPHG = 'NC'

INSERT INTO DEAN VALUES ('TH001', 'Tin hoc hoa 1', 'HANOI', 'NC', '01/02/2018', '01/02/2019')
INSERT INTO DEAN VALUES ('TH002', 'Tin hoc hoa 2', 'TPHCM', 'NC', '04/06/2018', '01/02/2019')
INSERT INTO DEAN VALUES ('DT001', 'Dao tao 1', 'NHATRANG', 'DH', '01/02/2017', '01/02/2021')
INSERT INTO DEAN VALUES ('DT002', 'Dao tao 2', 'HANOI', 'DH', '01/02/2017', '01/02/2021')

INSERT INTO PHANCONG VALUES ('001', 'TH001', '30')
INSERT INTO PHANCONG VALUES ('001', 'TH002', '12')
INSERT INTO PHANCONG VALUES ('002', 'TH001', '10')
INSERT INTO PHANCONG VALUES ('002', 'TH002', '10')
INSERT INTO PHANCONG VALUES ('002', 'DT001', '10')
INSERT INTO PHANCONG VALUES ('002', 'DT002', '10')
INSERT INTO PHANCONG VALUES ('003', 'TH001', '37')
INSERT INTO PHANCONG VALUES ('004', 'DT001', '22')
INSERT INTO PHANCONG VALUES ('004', 'DT002', '10')

--Câu 3:
--3a
SELECT TENPHG
FROM PHONGBAN PB, DEAN DA, PHANCONG PC, NHANVIEN NV
WHERE PB.MAPHG = DA.MAPHG AND DA.MADA = PC.MADA AND PC.MANV = NV.MANV
GROUP BY TENPHG
HAVING AVG(LUONG) >= 24000000
ORDER BY TENPHG DESC


--3b
SELECT HOTEN 
FROM PHONGBAN PB, DEAN DA, PHANCONG PC, NHANVIEN NV
WHERE PB.MAPHG = DA.MAPHG AND DA.MADA = PC.MADA AND PC.MANV = NV.MANV
AND PB.TENPHG = 'Nghien Cuu' AND DDIEM_DA = 'HANOI'

